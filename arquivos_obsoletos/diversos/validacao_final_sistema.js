/**
 * @fileoverview Script de valida√ß√£o final do sistema de notifica√ß√µes
 * @description Executa todos os testes de valida√ß√£o do sistema completo
 * @author Sistema de Loja de T√™nis FGT
 * @version 1.0 - PRODU√á√ÉO READY
 * @date 2025-07-05
 */

const axios = require('axios');
const mysql = require('mysql2/promise');

const BASE_URL = 'http://127.0.0.1:3000/api';
const DB_CONFIG = {
    host: 'localhost',
    user: 'root',
    password: '1234',
    database: 'projetofgt'
};

class ValidacaoFinalSistema {
    constructor() {
        this.token = null;
        this.usuario = null;
        this.sucessos = 0;
        this.total = 0;
        console.log('üî• VALIDA√á√ÉO FINAL DO SISTEMA DE NOTIFICA√á√ïES');
        console.log('üìÖ Data:', new Date().toLocaleString('pt-BR'));
        console.log('üéØ Objetivo: Validar sistema completo para produ√ß√£o\n');
    }

    /**
     * Contador de testes
     */
    adicionarTeste(sucesso) {
        this.total++;
        if (sucesso) this.sucessos++;
    }

    /**
     * 1. Validar conex√£o com banco de dados
     */
    async validarBancoDados() {
        try {
            console.log('1Ô∏è‚É£ VALIDANDO BANCO DE DADOS...');
            
            const connection = await mysql.createConnection(DB_CONFIG);
            console.log('   ‚úÖ Conex√£o MySQL estabelecida');
            
            // Verificar tabelas de notifica√ß√µes
            const tabelas = [
                'notificacoes_log',
                'usuarios_notificacoes', 
                'notificacoes_templates',
                'notificacoes_fila',
                'eventos_log'
            ];

            for (const tabela of tabelas) {
                const [rows] = await connection.execute(`SHOW TABLES LIKE '${tabela}'`);
                if (rows.length > 0) {
                    console.log(`   ‚úÖ Tabela '${tabela}' existe`);
                } else {
                    console.log(`   ‚ùå Tabela '${tabela}' n√£o encontrada`);
                    this.adicionarTeste(false);
                    return false;
                }
            }

            // Verificar colunas de notifica√ß√£o na tabela usuarios
            const [columns] = await connection.execute('DESCRIBE usuarios');
            const colunasNotificacao = ['notificacoes_email', 'notificacoes_sms', 'notificacoes_push', 'push_token'];
            const colunasExistentes = columns.map(col => col.Field);
            
            for (const coluna of colunasNotificacao) {
                if (colunasExistentes.includes(coluna)) {
                    console.log(`   ‚úÖ Coluna '${coluna}' existe na tabela usuarios`);
                } else {
                    console.log(`   ‚ùå Coluna '${coluna}' n√£o encontrada`);
                    this.adicionarTeste(false);
                    return false;
                }
            }

            // Verificar templates
            const [templates] = await connection.execute('SELECT COUNT(*) as total FROM notificacoes_templates');
            if (templates[0].total > 0) {
                console.log(`   ‚úÖ Templates encontrados: ${templates[0].total}`);
            } else {
                console.log('   ‚ùå Nenhum template encontrado');
                this.adicionarTeste(false);
                return false;
            }

            await connection.end();
            this.adicionarTeste(true);
            return true;

        } catch (error) {
            console.error('   ‚ùå Erro no banco:', error.message);
            this.adicionarTeste(false);
            return false;
        }
    }

    /**
     * 2. Validar autentica√ß√£o
     */
    async validarAutenticacao() {
        try {
            console.log('\n2Ô∏è‚É£ VALIDANDO AUTENTICA√á√ÉO...');
            
            const response = await axios.post(`${BASE_URL}/auth/login`, {
                email: 'thiagoeucosta@gmail.com',
                senha: '123456'
            });

            if (response.data.sucesso) {
                this.token = response.data.dados.token;
                this.usuario = response.data.dados.usuario;
                console.log('   ‚úÖ Login realizado com sucesso');
                console.log(`   üë§ Usu√°rio: ${this.usuario.nome}`);
                console.log(`   üéØ Tipo: ${this.usuario.tipo_usuario}`);
                console.log(`   üÜî ID: ${this.usuario.id}`);
                this.adicionarTeste(true);
                return true;
            } else {
                console.log('   ‚ùå Falha no login');
                this.adicionarTeste(false);
                return false;
            }

        } catch (error) {
            console.error('   ‚ùå Erro na autentica√ß√£o:', error.message);
            this.adicionarTeste(false);
            return false;
        }
    }

    /**
     * 3. Validar APIs de notifica√ß√µes
     */
    async validarAPIs() {
        try {
            console.log('\n3Ô∏è‚É£ VALIDANDO APIS DE NOTIFICA√á√ïES...');
            
            const headers = {
                'Authorization': `Bearer ${this.token}`,
                'Content-Type': 'application/json'
            };

            // Teste 1: Configura√ß√µes do sistema
            const configSistema = await axios.get(`${BASE_URL}/notificacoes/teste-configuracao`, { headers });
            if (configSistema.data.sucesso) {
                console.log('   ‚úÖ API de configura√ß√µes do sistema funcionando');
                this.adicionarTeste(true);
            } else {
                console.log('   ‚ùå API de configura√ß√µes falhou');
                this.adicionarTeste(false);
            }

            // Teste 2: Configura√ß√µes do usu√°rio
            const configUsuario = await axios.get(`${BASE_URL}/notificacoes/configuracao/${this.usuario.id}`, { headers });
            if (configUsuario.data.sucesso) {
                console.log('   ‚úÖ API de configura√ß√£o de usu√°rio funcionando');
                this.adicionarTeste(true);
            } else {
                console.log('   ‚ùå API de configura√ß√£o de usu√°rio falhou');
                this.adicionarTeste(false);
            }

            // Teste 3: Estat√≠sticas
            const estatisticas = await axios.get(`${BASE_URL}/notificacoes/estatisticas`, { headers });
            if (estatisticas.data.sucesso) {
                console.log('   ‚úÖ API de estat√≠sticas funcionando');
                this.adicionarTeste(true);
            } else {
                console.log('   ‚ùå API de estat√≠sticas falhou');
                this.adicionarTeste(false);
            }

            // Teste 4: Hist√≥rico
            const historico = await axios.get(`${BASE_URL}/notificacoes/historico/${this.usuario.id}`, { headers });
            if (historico.data.sucesso) {
                console.log('   ‚úÖ API de hist√≥rico funcionando');
                this.adicionarTeste(true);
            } else {
                console.log('   ‚ùå API de hist√≥rico falhou');
                this.adicionarTeste(false);
            }

            // Teste 5: Envio de teste
            const teste = await axios.post(`${BASE_URL}/notificacoes/teste`, {
                tipo: 'email',
                destinatario: 'teste@exemplo.com',
                template: 'pedido_criado'
            }, { headers });
            
            if (teste.data.sucesso !== undefined) {
                console.log('   ‚úÖ API de envio de teste funcionando');
                this.adicionarTeste(true);
            } else {
                console.log('   ‚ùå API de envio de teste falhou');
                this.adicionarTeste(false);
            }

            return true;

        } catch (error) {
            console.error('   ‚ùå Erro nas APIs:', error.message);
            this.adicionarTeste(false);
            return false;
        }
    }

    /**
     * 4. Validar sistema de eventos
     */
    async validarEventos() {
        try {
            console.log('\n4Ô∏è‚É£ VALIDANDO SISTEMA DE EVENTOS...');
            
            const headers = {
                'Authorization': `Bearer ${this.token}`,
                'Content-Type': 'application/json'
            };

            const eventoTeste = {
                tipo: 'pedido_criado',
                dados: {
                    pedido_id: 'TESTE-' + Date.now(),
                    usuario_id: this.usuario.id,
                    valor_total: 299.99,
                    nome_cliente: this.usuario.nome
                }
            };

            const response = await axios.post(`${BASE_URL}/notificacoes/evento`, eventoTeste, { headers });
            
            if (response.data.sucesso) {
                console.log('   ‚úÖ Sistema de eventos funcionando');
                console.log(`   üéØ Evento '${eventoTeste.tipo}' disparado com sucesso`);
                this.adicionarTeste(true);
                return true;
            } else {
                console.log('   ‚ùå Sistema de eventos falhou');
                this.adicionarTeste(false);
                return false;
            }

        } catch (error) {
            console.error('   ‚ùå Erro no sistema de eventos:', error.message);
            this.adicionarTeste(false);
            return false;
        }
    }

    /**
     * 5. Validar integra√ß√µes
     */
    async validarIntegracoes() {
        try {
            console.log('\n5Ô∏è‚É£ VALIDANDO INTEGRA√á√ïES...');
            
            // Verificar se os servi√ßos est√£o importados corretamente
            console.log('   üîç Verificando m√≥dulos do sistema...');
            
            // Testar health da API principal
            const health = await axios.get(`${BASE_URL}/health`);
            if (health.data.sucesso) {
                console.log('   ‚úÖ API principal funcionando');
                this.adicionarTeste(true);
            } else {
                console.log('   ‚ùå API principal com problemas');
                this.adicionarTeste(false);
            }

            // Verificar se as rotas est√£o registradas
            const info = await axios.get(`${BASE_URL}/info`);
            if (info.data.sucesso) {
                console.log('   ‚úÖ Sistema de informa√ß√µes funcionando');
                this.adicionarTeste(true);
            } else {
                console.log('   ‚ùå Sistema de informa√ß√µes com problemas');
                this.adicionarTeste(false);
            }

            return true;

        } catch (error) {
            console.error('   ‚ùå Erro nas integra√ß√µes:', error.message);
            this.adicionarTeste(false);
            return false;
        }
    }

    /**
     * Executar valida√ß√£o completa
     */
    async executarValidacaoCompleta() {
        console.log('‚ïê'.repeat(60));
        console.log('üöÄ INICIANDO VALIDA√á√ÉO COMPLETA DO SISTEMA');
        console.log('‚ïê'.repeat(60));

        // Executar todas as valida√ß√µes
        await this.validarBancoDados();
        await this.validarAutenticacao();
        await this.validarAPIs();
        await this.validarEventos();
        await this.validarIntegracoes();

        // Relat√≥rio final
        console.log('\n' + '‚ïê'.repeat(60));
        console.log('üìä RELAT√ìRIO FINAL DA VALIDA√á√ÉO');
        console.log('‚ïê'.repeat(60));
        
        const porcentagem = ((this.sucessos / this.total) * 100).toFixed(1);
        console.log(`‚úÖ Testes bem-sucedidos: ${this.sucessos}/${this.total}`);
        console.log(`üìà Taxa de sucesso: ${porcentagem}%`);

        if (this.sucessos === this.total) {
            console.log('\nüéâ SISTEMA 100% VALIDADO E PRONTO PARA PRODU√á√ÉO!');
            console.log('üèÜ Todos os componentes est√£o funcionando perfeitamente');
            console.log('üöÄ O sistema pode ser usado em ambiente de produ√ß√£o');
        } else if (porcentagem >= 80) {
            console.log('\n‚ö†Ô∏è Sistema funcionando com pequenos problemas');
            console.log('üîß Alguns ajustes menores podem ser necess√°rios');
        } else {
            console.log('\n‚ùå Sistema com problemas significativos');
            console.log('üî® Corre√ß√µes necess√°rias antes da produ√ß√£o');
        }

        console.log('\nüìã Pr√≥ximos passos:');
        console.log('   1. Configure credenciais reais de email/SMS/push');
        console.log('   2. Teste envio real de notifica√ß√µes');
        console.log('   3. Configure monitoramento em produ√ß√£o');
        console.log('   4. Implemente backup autom√°tico');

        console.log('\n‚ú® Valida√ß√£o conclu√≠da em:', new Date().toLocaleString('pt-BR'));
        console.log('‚ïê'.repeat(60));
    }
}

// Executar valida√ß√£o
(async () => {
    const validacao = new ValidacaoFinalSistema();
    await validacao.executarValidacaoCompleta();
})().catch(error => {
    console.error('‚ùå Erro fatal na valida√ß√£o:', error);
});
